<html>
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">   
        
		<script src="js/jquery-3.4.0.js"></script>
		<script src="js/sweetalert2.all.min.js"></script>
		
		<!-- Materializer -->
		<link rel="stylesheet" href="materialize/css/materialize.min.css">
        <script src="materialize/js/materialize.min.js"></script>
		
		<!-- Datatable -->
		<script src="js/jquery.dataTables.min.js"></script> 
		<link rel="stylesheet" href="css/jquery.dataTables.min.css">
		
		<!-- Jquery UI Datepicker -->
		<link rel="stylesheet" href="css/jquery-ui.css">
		<script src="js/jquery-ui.js"></script>
		
		<!-- Jquery UI Timepicker -->
		<link rel="stylesheet" href="css/jquery.timepicker.min.css">
		<script src="js/jquery.timepicker.min.js"></script>
		
		<link rel="stylesheet" href="css/my-style.css">
    </head>
    <body>
        <div class="container">
			<div id="input-form" class="f-50">
				<div class="row">
					<h4>Data Event</h4>
				</div>
				<div class="row">
					<div class="input-field col s12">
						<input id="event" placeholder="Kegiatan" type="text">
						<label for="event">Kegiatan/Event/Seminar*</label>
					</div>
				</div>
				<div class="row">	
					<div class="input-field col s12">
						<input id="desk" placeholder="Deskripsi lengkap kegiatan" type="text">
						<label for="desk">Deskripsi*</label>
					</div>
				</div>
				<div class="row">	
					<div class="input-field col s6">
						<input id="tgl" placeholder="Tanggal" type="text" autocomplete="off">
						<label for="tgl">Tanggal*</label>
					</div>
					<div class="input-field col s6">
						<input id="jam" placeholder="Jam" type="text" autocomplete="off">
						<label for="jam">Jam*</label>
					</div>
				</div>
				<div class="row">	
					<div class="input-field col s12">
						<button id="reset" class="btn waves-effect waves-light">RESET</button>
						<button id="submit" class="btn waves-effect waves-light" style="z-index:0">SIMPAN</button>
						<button id="tutup" class="btn waves-effect waves-light" style="z-index:0">TUTUP</button>
					</div>
				</div>
			</div>
			<div id="table-data">
				<div class="row">	
					<div class="input-field col s12">
						<button id="tambah" class="btn waves-effect waves-light">TAMBAH</button>
						<table>
							<thead>
								<th>Event</th>
								<th>Deskripsi</th>
								<th>Tanggal</th>
								<th>Jam</th>
								<th>&nbsp;</th>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>
        </div>   

        <script type="text/javascript">	
            $(function (){
				var table, tempID;
				var baseUrl = "/";
				
				$("#input-form").hide();
				
				$( "#tgl" ).datepicker({
					dateFormat: "yy-mm-dd"
				});
  			
				$("#jam").timepicker({
					timeFormat: 'HH:mm',
				});
			
				$("#tambah").click(function(){
					$("#input-form").show();
					$("#table-data").hide();
				});
				
				$("#tutup").click(function(){
					$("#input-form").hide();
					$("#table-data").show();
					
					$("table").DataTable().clear().destroy();
					loadGrid();
				});
					
				loadGrid();
				
				function loadGrid(){
                    myUrl = baseUrl + "event.php?action=4";
					
					$.ajax({
                        url: myUrl, 
                        dataType: "json",
                        beforeSend:function(){
                            $("#loader").fadeIn();
						},
                        success: function(result){ 
                            var rows, json = result.result; //ambil object "result"
                            
							console.log(json);
							
                            table = 
                            $("table").DataTable( {
                               "language": {
                                    "emptyTable": "Tak ada Data"
                                },
                                data: json,
                                columns: [
                                    { data: 'event' },
                                    { data: 'description' },
                                    { data: 'date' },
                                    { data: 'time' },
                                    { 
                                        data: null,
                                        "bSortable": false,
                                        "mRender": function (data) {
                                            var s ='<a href="#" id= ' + data.id + ' class="ubah">' + 'Ubah' + '</a> ' +
                                                    '<a href="#" id= ' + data.id + ' class="hapus">' + 'Hapus' + '</a>';  
                                            return s
                                        }
                                    }
                                ],
                            });

							$('table tbody').on( 'click', 'a', function () {
                            
                                var data = table.row( $(this).parents('tr') ).data();
                                //console.log(data);

                                var jenis = $(this).attr('class');

                                if (jenis == "ubah"){
									tempID = data['id'] 
                                    $("#event").val(data[ 'event' ]);
                                    $("#desk").val(data[ 'description' ]);
                                    $("#tgl").val(data[ 'date' ]);
                                    $("#jam").val(data[ 'time' ]);                              
									
									$("#input-form").fadeIn();
									$("#table-data").fadeOut();
                                }else if(jenis == "hapus"){
                                    id = data['id'];

                                    Swal.fire({
                                        title: "Konfirmasi",
                                        text: "Data yang telah dihapus tak dapat dikembalikan",
                                        type:"warning",
                                        showCancelButton: true,
                                        confirmButtonText: "Hapus data",
                                    })

                                    .then((result) =>{
                                        if (result){
                                            $.ajax({
                                                url: baseUrl + "event.php?action=3&id="+id,
                                                dataType: "json",
                                                success: function(result){
                                                    var obj = result.hasil; //ambil object hasil
                                                    var psn;

                                                    //ambil pesan dari json
                                                    $.each(obj, function(key, val){
                                                        console.log("key val "+ key + " " + val.pesan);
                                                        psn = val.pesan;
                                                    });

                                                    Swal.fire("Konfirmasi", psn, "success");

                                                    table.destroy();
                                                    loadGrid();
                                                }
                                            });
                                        }else{
                                            Swal.fire("Penghapusan data dibatalkan");
                                        }
                                    });
                                }
                            });
							
							$("#loader").fadeOut();
                        },

                        fail: function(xhr, textStatus, errorThrown){
                            Swal.fire(textStatus, errorThrown, "error");
                        }
                    });  
                };

				$("#reset").click(function(){
					$("#event").val("");
					$("#desk").val("");
					$("#tgl").val("");
					$("#jam").val("");
				});

				$("#submit").click(function(){
					var event = $("#event").val();
					var desk = $("#desk").val();
					var tgl = $("#tgl").val();
					var jam = $("#jam").val();
					
					if (event.length == 0 || desk.length == 0 || tgl.length == 0 || jam.length == 0  ){
                        Swal.fire({
                                type: 'info',
                                title: 'Lengkapi data',
                                text: 'Data yang disimpan harus lengkap',
                                footer: ''
                            })

                        return;
                    }   
					
					var myUrl;
					
					if (tempID == null || tempID == "" ){
						myUrl = baseUrl + "event.php?action=1&event=" + event + "&deskripsi=" + desk +
								"&tgl=" + tgl + "&jam=" + jam;
					}else{
						myUrl = baseUrl + "event.php?action=2&id="+ tempID +"&event=" + event + "&deskripsi=" + desk +
								"&tgl=" + tgl + "&jam=" + jam;
					}
					
					console.log(myUrl);
					
					$("#submit").attr("disabled", true);
                       
					$.ajax({
                        url: myUrl,
                        success: function(result){  
                            Swal.fire({
                                type: 'success',
                                title: 'Data tersimpan',
                                text: name + ' disimpan',
                                footer: ''
                            })
                            
                            $("#reset").click();
                            $("#submit").attr("disabled", false);
                        },
                        fail: function(xhr, textStatus, errorThrown){
                            Swal.fire({
                                type: 'error',
                                title: textStatus,
                                text: errorThrown,
                                footer: ''
                            });

                            $("#submit").attr("disabled", false);
                        }
                    });
				});
				
			});
        </script>
    </body>
</html>