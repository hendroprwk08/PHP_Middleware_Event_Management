<html>
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">  
        <meta name="viewport" content="width=device-width, initial-scale=1.0">  

         
        <link rel="stylesheet" href="materialize/css/materialize.min.css">
        <script src="materialize/js/materialize.min.js"></script>

        <script src="js/jquery-3.4.0.js"></script>
        <script src="js/sweetalert2.all.min.js"></script>

        <style>
            .container{
                width: 30%;
				margin-top:30;	
			}
			
			@media only screen and (max-width: 600px) {
              .container{
                width: 90%;
				margin-top:30;	
			  }
            }
            
            @media only screen and (max-width: 801px) {
              .container{
                width: 70%;
				margin-top:30;	
			  }
            }
            
             @media only screen and (max-width: 1025px) {
              .container{
                width: 70%;
				margin-top:30;	
			  }
            }
            
        </style>
    </head>
    <body>
        <div class="container">                   
            <div class="row">
                <div class="input-field col s12">
                    <h4>Pendaftaran</h4>
                </div>

                <div id="check" >
                    <div class="row">
                        <div class="input-field col s12">
                            <input placeholder="Ketik nomer aktifmu" id="c_phone" type="text">
                            <label for="c_phone">Nomer Telepon</label>
                        </div>
                        
                        <div class="input-field col s12">
                            <button id="bt_check" class="btn waves-effect waves-light">SELANJUTNYA</button>
                        </div>     
                    </div>   
                </div>

                <div id = "pendaftaran">
                    <div class="input-field col s12">
                        <input id="name" placeholder="Nama" type="text">
                        <label for="name">Nama Lengkap*</label>
                    </div>

                    <div class="input-field col s12">
                        <input id="institusi" placeholder="Tempatmu beraktifitas" type="text">
                        <label for="institusi">Sekolah / Kampus / Kantor*</label>
                    </div>

                    <div class="input-field col s6">
                        <input id="wa" placeholder="Nomer utama" type="text">
                        <label for="wa">Nomer Whatsapp*</label>
                    </div>

                    <div class="input-field col s6">
                        <input id="phone" placeholder="Nomer alternatif" type="text">
                        <label for="phone">Nomer Telepon</label>
                    </div>

                    <div class="input-field col s12">
                        <input id="email" type="text" placeholder="Email yang aktif kamu pakai">
                        <label for="email">Email*</label>
                    </div>

                    <div class="input-field col s12">
                        <div class = "row"  style="margin-top:-10px; padding:0 10px 0 10px">
                            <label for="kegiatan">Kegiatan</label>
                            <select id="kegiatan"></select>
                        </div>
                    </div>
                    
                    <div class="input-field col s12">
                        <button id="back" class="btn waves-effect waves-light">KEMBALI</button>
                        <button id="submit" class="btn waves-effect waves-light">DAFTAR</button>
                    </div> 
                </div>               
            </div>
        </div>   

        <script type="text/javascript">
            $(document).ready(function ()
            {
                var URL = "https://event-lcc-me.000webhostapp.com/";
                var id, res, id_participants = null, name, institution, whatsapp, phone, c_phone, email;
				
                $("#pendaftaran").hide();
                $("#check").show();                

                $('select').attr("class", "browser-default"); //menampilkan(render) select
                
                //load kegiatan
                $.ajax({
                    url: URL + 'load_event.php?action=1', 
                    
                    success: function(result){
                        //var json = JSON.parse(result);  
                        var json = result;  
                        
                        res = ""; 
                        $.each(json['result'], function(index, element) {
                            res += "<option value='"+ element.id + "'>" + element.event +": "+ element.date + " "+ element.time +"</option>";                            
                        });  

                        $("select").append(res); 
                    },

                    fail: function(xhr, textStatus, errorThrown){
                        console.log(textStatus + ": " + errorThrown);
                    }
                });      

                $("#bt_check").click(function() {
                    c_phone = $("#c_phone").val();

                    if (c_phone.length == 0){
                        Swal.fire({
                                type: 'info',
                                title: 'Perhatian',
                                text: 'Isi nomer ponselmu',
                                footer: ''
                            });

                        return;
                    }

                    $.ajax({
                        url: URL + 'check_number.php?phone='+ c_phone ,
                        
                        success: function(result){
                            console.log(result); 
                           
                            //var json = JSON.parse(result);  
                            var json = result;  
                            
                            res = json['result'];
                            
                            console.log(res);
                            if (res.length != 0){
                                $.each(res, function(index, element) {
                                    id_participants = element.id;
                                    $("#name").val(element.name);
                                    $("#institusi").val(element.institution);
                                    $("#wa").val(element.whatsapp);
                                    $("#phone").val(element.phone);
                                    $("#email").val(element.email);
                                });  


                            }else{
                                console.log(c_phone);
                                id_participants = null;
								$("#wa").val(c_phone);
                            } 

                            $("#pendaftaran").show();
                            $("#check").hide();                         
                        },

                        fail: function(xhr, textStatus, errorThrown){
                            Swal.fire({
                                type: 'error',
                                title: textStatus,
                                text: errorThrown,
                                footer: ''
                            });

                            $("#loader").hide();
                            $("#submit").attr("disabled", false);
                        }
                    });           
                });

                $("#back").click(function() {
                    $("#pendaftaran").hide();
                    $("#check").show();   
                });

                $("#submit").click(function() {
                    var name = $("#name").val();
                    var institution = $("#institusi").val();
                    var wa = $("#wa").val();
                    var phone = $("#phone").val();
                    var email = $("#email").val();
                    var kegiatan = $("#kegiatan").val();                    
                
                    if (kegiatan === null){
                        Swal.fire({
                                type: 'info',
                                title: 'Pilih kegiatanmu',
                                text: 'Kamu belum memilih kegiatan yang akan dihadiri',
                                footer: ''
                            })

                        return;
                    }   

                    var reg  = /\S+@\S+\.\S+/;  
                    if (name.length == 0 || institution.length == 0 || wa.length == 0 || kegiatan === null || !reg.test(email)){
                        Swal.fire({
                                type: 'info',
                                title: 'Lengkapi data dengan benar',
                                text: 'Nama, institusi, whatsapp, email',
                                footer: ''
                            })

                        return;
                    }                    

                    $("#submit").attr("disabled", true);
                
                    var action_url;
					
					console.log("participants: " +id_participants);
					
                    if (id_participants == null){
                        action_url = URL + 'daftar_front.php?event_id='+ kegiatan +'&nama=' + name + '&kampus=' + institution + '&wa=' + wa + '&phone=' + phone + '&email=' + email+'&active=Yes';
                    }else{
                        action_url = URL + 'daftar_front_exist.php?event_id='+ kegiatan +'&id=' + id_participants; 
                    }

					console.log(action_url);
					
                    $.ajax({
                        url: action_url, 
                        success: function(result){  
                            Swal.fire({
                                type: 'success',
                                title: 'Data tersimpan',
                                text: name + ' disimpan',
                                footer: ''
                            })
                            
                            $("#c_phone").val("");
                            $("#name").val("");
                            $("#institusi").val("");
                            $("#wa").val("");
                            $("#phone").val("");
                            $("#email").val("");
                            $("#kegiatan").val("");

                            $("#back").click();
                            $("#submit").attr("disabled", false);
                        },

                        fail: function(xhr, textStatus, errorThrown){
                            Swal.fire({
                                type: 'error',
                                title: textStatus,
                                text: errorThrown,
                                footer: ''
                            });

                            $("#submit").attr("disabled", false);
                        }
                    });                  
                });
            });
        </script>
    </body>
</html>